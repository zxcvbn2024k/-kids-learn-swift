<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬å†¬æ—¥ç´€è¡Œ 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'zen-beige': '#F9F8F6',
                        'zen-dark': '#2D2D2D',
                        'sakura-pink': '#FCE4EC',
                        'zen-gold': '#C5A36B'
                    },
                    fontFamily: {
                        serif: ['"Noto Serif JP"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F9F8F6; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; padding-bottom: 80px; }
        .active-tab { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .zen-card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #F0EFEA; }
        .sakura-bg { background-image: radial-gradient(#FCE4EC 1px, transparent 1px); background-size: 20px 20px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input:focus { outline: none; }
    </style>
</head>
<body class="sakura-bg text-zen-dark">

    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100 p-4 flex justify-between items-center">
        <h1 class="font-serif font-bold text-xl tracking-widest text-zen-dark">æ—¥æœ¬å†¬æ—¥ç´€è¡Œ <span class="text-pink-400 text-sm">ğŸŒ¸</span></h1>
        <div id="weather-icon" class="text-zen-gold text-sm font-medium">12/23 - 12/27</div>
    </header>

    <main class="max-w-md mx-auto p-4">

        <section id="tab-plan" class="tab-content active-tab">
            <div class="zen-card p-4 mb-6 border-l-4 border-pink-200">
                <div class="flex justify-between items-center mb-2 text-xs text-gray-400 font-bold uppercase tracking-wider">
                    <span>Flight Information</span>
                    <i class="fas fa-plane"></i>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-500 text-xs">å»ç¨‹ 12/23 (äºŒ)</p>
                        <p class="font-bold text-lg">BR158</p>
                        <p>TPE 06:35 â†’ KMQ 10:25</p>
                    </div>
                    <div class="border-l pl-4 text-right">
                        <p class="text-gray-500 text-xs">å›ç¨‹ 12/27 (å…­)</p>
                        <p class="font-bold text-lg">BR157</p>
                        <p>KMQ 11:45 â†’ TPE 14:35</p>
                    </div>
                </div>
            </div>

            <div id="itinerary-list" class="space-y-8 relative before:content-[''] before:absolute before:left-3 before:top-4 before:bottom-4 before:w-0.5 before:bg-pink-100">
                
                <div class="relative pl-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-pink-400 rounded-full border-4 border-white shadow-sm flex items-center justify-center text-[10px] text-white font-bold">1</div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-serif font-bold text-lg">12/23 å°åŒ— - å°æ¾ - é‡‘æ¾¤</h3>
                        <span class="bg-gray-100 text-[10px] px-2 py-1 rounded">2~8Â°C â˜ï¸</span>
                    </div>
                    <div class="zen-card p-4 space-y-3 text-sm">
                        <p class="font-medium text-gray-700">å°æ¾ç©ºæ¸¯ â” é‡‘æ¾¤å…¼å…­åœ’ â” æ±èŒ¶å±‹è¡— â” é¦™æ—åŠæ•£ç­–</p>
                        <div class="flex gap-2">
                            <a href="https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤å…¼å…­åœ’" class="bg-zen-beige px-3 py-1.5 rounded-full text-xs flex items-center gap-1 border border-gray-200"><i class="fas fa-map-marker-alt text-red-400"></i> å…¼å…­åœ’åœ°åœ–</a>
                            <a href="https://www.google.com/search?q=é‡‘æ¾¤é¦™æ—åŠç¾é£Ÿæ¨è–¦" class="bg-zen-beige px-3 py-1.5 rounded-full text-xs flex items-center gap-1 border border-gray-200"><i class="fas fa-utensils text-orange-400"></i> é¦™æ—åŠé£Ÿè¨˜</a>
                        </div>
                        <div class="bg-pink-50/50 p-2 rounded text-xs text-pink-700">
                            <b>ğŸ’¡ æ¨è–¦ï¼š</b>é¦™æ—åŠé™„è¿‘æœ‰è¨±å¤šé‡‘ç®”å†°æ·‡æ·‹ï¼Œæ™šé¤æ¨è–¦åˆ°ã€Œè¿‘æ±Ÿç”ºå¸‚å ´ã€æˆ–é¦™æ—åŠçš„å±…é…’å±‹ã€‚
                        </div>
                        <button onclick="editNote('note-d1')" class="w-full text-left py-2 px-3 bg-gray-50 rounded border-dashed border border-gray-300 text-gray-400 text-xs" id="note-d1">
                            <i class="fas fa-edit mr-1"></i> é»æ“Šè¨­å®šé›†åˆæ™‚é–“...
                        </button>
                        <div class="mt-4 pt-4 border-t">
                            <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Accommodation</p>
                            <p class="font-bold">æ±æ€¥å¯Œå±±å“è¶Šå¤§é…’åº—</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=TOYAMA+EXCEL+HOTEL+TOKYU" class="inline-block mt-2 text-blue-500 text-xs font-medium">é–‹å•Ÿ Google Maps <i class="fas fa-external-link-alt text-[10px]"></i></a>
                        </div>
                    </div>
                </div>

                <div class="relative pl-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-pink-300 rounded-full border-4 border-white shadow-sm flex items-center justify-center text-[10px] text-white font-bold">2</div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-serif font-bold text-lg">12/24 é›ªè¦‹éŠèˆ¹ - åˆæŒæ‘</h3>
                        <span class="bg-gray-100 text-[10px] px-2 py-1 rounded">-2~4Â°C â„ï¸</span>
                    </div>
                    <div class="zen-card p-4 space-y-3 text-sm">
                        <p class="font-medium text-gray-700">åº„å·å³½éŠèˆ¹ â” ç™½å·é„‰åˆæŒæ‘ â” é«˜å±±ä¸‰ä¹‹ç”ºå¤è¡—</p>
                        <div class="flex gap-2">
                            <a href="https://www.google.com/maps/search/?api=1&query=ç™½å·é„‰åˆæŒæ‘" class="bg-zen-beige px-3 py-1.5 rounded-full text-xs flex items-center gap-1 border border-gray-200"><i class="fas fa-map-marker-alt text-red-400"></i> åˆæŒæ‘åœ°åœ–</a>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Accommodation</p>
                            <p class="font-bold">é«˜å±±å¯¶ç”Ÿé–£</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=1+Chome-1-88+Babamachi+Takayama" class="inline-block mt-2 text-blue-500 text-xs font-medium">é–‹å•Ÿ Google Maps <i class="fas fa-external-link-alt text-[10px]"></i></a>
                        </div>
                    </div>
                </div>

                <div class="relative pl-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-pink-300 rounded-full border-4 border-white shadow-sm flex items-center justify-center text-[10px] text-white font-bold">3</div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-serif font-bold text-lg">12/25 æ–°ç©—é«˜ - åå¤å±‹</h3>
                        <span class="bg-gray-100 text-[10px] px-2 py-1 rounded">0~9Â°C â˜€ï¸</span>
                    </div>
                    <div class="zen-card p-4 space-y-3 text-sm">
                        <p class="font-medium text-gray-700">æ–°ç©—é«˜çºœè»Š â” åå¤å±‹æ¦®åœ°ä¸‹è¡— â” åèŠ±ä¹‹é‡Œ</p>
                        <div class="bg-blue-50 p-2 rounded text-xs text-blue-700">
                            <b>ğŸ´ æ¨è–¦é£Ÿç‰©ï¼š</b>åèŠ±ä¹‹é‡Œå…§çš„ã€Œé•·å³¶å•¤é…’åœ’ã€æˆ–å„é¡æ—¥å¼ç‰¹è‰²å®šé£Ÿï¼Œè³ç‡ˆå¾Œç”¨é¤æœ€ç¾ã€‚
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Accommodation</p>
                            <p class="font-bold">KURETAKE-INN åå¤å±‹ä¹…å±‹å¤§é€š</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Kuretake+Inn+Nagoya+Hisayaodori" class="inline-block mt-2 text-blue-500 text-xs font-medium">é–‹å•Ÿ Google Maps <i class="fas fa-external-link-alt text-[10px]"></i></a>
                        </div>
                    </div>
                </div>

                <div class="relative pl-8">
                    <div class="absolute left-0 top-1 w-6 h-6 bg-pink-300 rounded-full border-4 border-white shadow-sm flex items-center justify-center text-[10px] text-white font-bold">4</div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-serif font-bold text-lg">12/26 ç†±ç”°ç¥å®® - ç‰§æ­Œä¹‹é‡Œ</h3>
                        <span class="bg-gray-100 text-[10px] px-2 py-1 rounded">2~10Â°C â˜ï¸</span>
                    </div>
                    <div class="zen-card p-4 text-sm">
                         <p class="font-medium text-gray-700">ç†±ç”°ç¥å®® â” å…ç¨…åº— â” ç‰§æ­Œä¹‹é‡Œ(æˆ²é›ª) â” å°æ¾AEON</p>
                         <div class="mt-4 pt-4 border-t text-xs">
                             <p class="text-gray-400 font-bold mb-1">HOTEL: å¤§æ±Ÿæˆ¶æº«æ³‰ å±±ä¸­å½©æœæ¨‚</p>
                         </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-guide" class="tab-content">
            <h2 class="font-serif text-2xl font-bold mb-6 text-center border-b pb-4">æ–‡åŒ–éš¨ç­†</h2>
            
            <article class="mb-10">
                <div class="relative h-40 w-full rounded-2xl overflow-hidden mb-4">
                    <img src="https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=400" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end p-4">
                        <h3 class="text-white font-serif text-xl">é‡‘æ¾¤ãƒ»å…¼å…­åœ’</h3>
                    </div>
                </div>
                <div class="columns-1 text-sm leading-relaxed text-gray-600 font-serif">
                    <p class="mb-2">å…¼å…­åœ’ä½œç‚ºæ—¥æœ¬ä¸‰å¤§ååœ’ä¹‹ä¸€ï¼Œæ„æŒ‡å…·å‚™ã€Œå®å¤§ã€å¹½é‚ƒã€äººåŠ›ã€è’¼å¤ã€æ°´æ³‰ã€çœºæœ›ã€å…­ç¨®å»ºç¯‰ç¾å­¸ã€‚å†¬å­£æœ€è‘—åçš„ä¾¿æ˜¯ã€Œé›ªåŠï¼ˆYukitsuriï¼‰ã€ï¼Œç‚ºäº†é˜²æ­¢åšé‡ç©é›ªå£“å®æ¾æ¨¹ï¼Œè·äººä»¥ç¹©ç´¢æ‹‰æˆå¹¾ä½•éŒå½¢ï¼Œå½¢æˆå†¬æ—¥é‡‘æ¾¤ç¨æœ‰çš„è¦–è¦ºè—è¡“ã€‚</p>
                </div>
            </article>

            <article class="mb-10">
                <h3 class="font-serif font-bold text-lg mb-2 border-l-4 border-zen-gold pl-2">åèŠ±ä¹‹é‡Œ (Nabana no Sato)</h3>
                <p class="text-sm text-gray-600 leading-relaxed mb-4">ä½æ–¼ä¸‰é‡ç¸£é•·å³¶åº¦å‡æ‘å…§ï¼Œæ˜¯æ—¥æœ¬æœ€å¤§ç´šåˆ¥çš„ç‡ˆç¯€ã€‚å…¶ç‡ˆå…‰éš§é“é•·é” 200 å…¬å°ºï¼Œæ•¸ç™¾è¬é¡† LED ç‡ˆéš¨è‘—å­£ç¯€è®Šæ›å±•ç¾æ°´å¢¨ç•«èˆ¬çš„æµå‹•æ„Ÿï¼Œéå¸¸é©åˆåœ¨ DAY 3 æ™šé–“æ¼«æ­¥ã€‚</p>
                <div class="w-full h-64 rounded-xl overflow-hidden shadow-inner">
                    <iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=136.7027,35.0747,136.7111,35.0801&layer=mapnik"></iframe>
                </div>
            </article>
        </section>

        <section id="tab-wallet" class="tab-content">
            <div class="zen-card p-6 mb-6 bg-gradient-to-br from-white to-pink-50">
                <h3 class="text-xs font-bold text-gray-400 mb-4 tracking-widest uppercase">Currency Converter</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between border-b pb-2">
                        <span class="text-xs text-gray-500 uppercase">JPY</span>
                        <input type="text" id="calc-input" placeholder="è¼¸å…¥é‡‘é¡æˆ–ç®—å¼ (å¦‚ 500+200)" class="text-right w-2/3 bg-transparent font-bold text-xl placeholder:text-gray-200" oninput="calculate()">
                    </div>
                    <div class="flex items-center justify-between text-pink-400">
                        <span class="text-xs uppercase">TWD</span>
                        <div class="text-2xl font-bold"><span id="calc-result">0</span> <span class="text-xs">NTD</span></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="rate-input" value="0.21" step="0.001" class="w-16 text-xs bg-white border rounded px-1 text-gray-400" title="åŒ¯ç‡">
                        <span class="text-[10px] text-gray-400 flex items-center">â† ç•¶å‰è‡ªè¨‚åŒ¯ç‡</span>
                    </div>
                </div>
            </div>

            <div class="zen-card p-4 mb-6">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="item-name" placeholder="å“é …åç¨±" class="border rounded-lg px-3 py-2 text-sm">
                    <input type="number" id="item-amount" placeholder="æ—¥å¹£é‡‘é¡" class="border rounded-lg px-3 py-2 text-sm">
                </div>
                <div class="flex gap-2">
                    <label class="flex-1 bg-gray-100 rounded-lg py-2 flex items-center justify-center cursor-pointer text-gray-500 text-sm">
                        <i class="fas fa-camera mr-2"></i> æ‹æ”¶æ“š
                        <input type="file" accept="image/*" class="hidden" onchange="handleImage(this)">
                    </label>
                    <button onclick="addExpense()" class="flex-1 bg-zen-dark text-white rounded-lg py-2 font-bold text-sm">å­˜å…¥å¸³æœ¬</button>
                </div>
                <div id="preview-container" class="mt-2 hidden">
                    <img id="img-preview" class="h-20 w-20 object-cover rounded-md border">
                </div>
            </div>

            <div id="expense-list" class="space-y-3">
                </div>
        </section>

        <section id="tab-lists" class="tab-content">
            <div class="mb-6">
                <h3 class="font-serif font-bold mb-3 border-b pb-2">ğŸ§³ è¡Œå‰æª¢æŸ¥ Checklist</h3>
                <div id="checklist-container" class="space-y-2">
                    </div>
            </div>

            <div class="mb-6">
                <h3 class="font-serif font-bold mb-3 border-b pb-2">ğŸ“ å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="memo-input" class="w-full zen-card p-4 text-sm h-32 focus:border-pink-200 transition-colors" placeholder="è¼¸å…¥è¡Œç¨‹ç­†è¨˜æˆ–ç¶²å€..."></textarea>
                <div id="memo-links" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        </section>

        <section id="tab-info" class="tab-content space-y-4">
            <div class="zen-card p-4">
                <h3 class="font-bold mb-3 text-red-500"><i class="fas fa-exclamation-triangle"></i> ç·Šæ€¥è¯çµ¡</h3>
                <div class="text-sm space-y-2">
                    <p class="flex justify-between"><span>è­¦å¯Ÿå±€</span> <span class="font-bold">110</span></p>
                    <p class="flex justify-between"><span>æ•‘è­·è»Š / ç«è­¦</span> <span class="font-bold">119</span></p>
                    <p class="flex justify-between"><span>é§æ—¥ä»£è¡¨è™• (æ±äº¬)</span> <span class="font-bold">+81-3-3280-7811</span></p>
                    <p class="pt-2 text-xs text-gray-500 border-t">å¤–å¹£ä¸Ÿå¤±/ä¿¡ç”¨å¡æ›å¤±è«‹æŸ¥é–±å„ç™¼å¡è¡Œ 24h æµ·å¤–é›»è©±ã€‚</p>
                </div>
            </div>

            <div class="zen-card p-4">
                <h3 class="font-bold mb-3 text-zen-gold text-sm uppercase">æ—…éŠè¦ç¯„èˆ‡ç¦å¿Œ</h3>
                <ul class="text-xs space-y-2 text-gray-600 list-disc pl-4">
                    <li>ç¦æ­¢æ”œå¸¶è‚‰é¡è£½å“ (æ³¡éºµå«è‚‰é«”ä¸å¯)ã€æ–°é®®è”¬æœå…¥å¢ƒæ—¥æœ¬åŠè¿”å°ã€‚</li>
                    <li>è¡Œå‹•é›»æºéœ€éš¨èº«æ”œå¸¶ï¼Œä¸å¯è¨—é‹ã€‚160WHä»¥ä¸Šç¦æ­¢å¸¶ä¸Šæ©Ÿã€‚</li>
                    <li>æ‰‹ææ¶²é«”å–®ç“¶ä¸å¾—è¶…é 100mlï¼Œéœ€æ”¾å…¥ 1L é€æ˜å¯†å°è¢‹ã€‚</li>
                    <li>æ—¥æœ¬åº—å®¶å¤§å¤šç¦æ­¢é‚Šèµ°é‚Šåƒï¼Œå»ºè­°åœ¨æ”¤ä½æ—æˆ–åº—å…§é£Ÿç”¨ã€‚</li>
                </ul>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-gray-100 flex justify-around p-3 z-50">
        <button onclick="switchTab('plan')" class="nav-item text-zen-gold flex flex-col items-center">
            <i class="fas fa-map-marked-alt text-xl"></i><span class="text-[10px] mt-1 font-bold">PLAN</span>
        </button>
        <button onclick="switchTab('guide')" class="nav-item text-gray-300 flex flex-col items-center">
            <i class="fas fa-book-open text-xl"></i><span class="text-[10px] mt-1 font-bold">GUIDE</span>
        </button>
        <button onclick="switchTab('wallet')" class="nav-item text-gray-300 flex flex-col items-center">
            <i class="fas fa-wallet text-xl"></i><span class="text-[10px] mt-1 font-bold">WALLET</span>
        </button>
        <button onclick="switchTab('lists')" class="nav-item text-gray-300 flex flex-col items-center">
            <i class="fas fa-tasks text-xl"></i><span class="text-[10px] mt-1 font-bold">LISTS</span>
        </button>
        <button onclick="switchTab('info')" class="nav-item text-gray-300 flex flex-col items-center">
            <i class="fas fa-info-circle text-xl"></i><span class="text-[10px] mt-1 font-bold">INFO</span>
        </button>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // *** é€™æ˜¯æ‚¨å°ˆå±¬çš„ Firebase é…ç½®è³‡è¨Š (ä¾†è‡ªæ‚¨çš„åœ–ç‰‡) ***
        const firebaseConfig = {
          apiKey: "AIzaSyDe5FfIoneooLLfIo54bhwSvqPuVMJndlJM",
          authDomain: "japan1223-50ca5.firebaseapp.com",
          projectId: "japan1223-50ca5",
          storageBucket: "japan1223-50ca5.appspot.com",
          messagingSenderId: "161432666966",
          appId: "1:161432666966:web:cc7616665a36ab0969ccf7"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);

        // å–å¾— Firestore æœå‹™çš„åƒè€ƒ
        const db = firebase.firestore();

        // å®šç¾© Firestore é›†åˆåç¨±
        const EXPENSES_COLLECTION = "japan1223_expenses"; 
    </script>
    <script>
        // --- æ ¸å¿ƒåŠŸèƒ½: åˆ†é åˆ‡æ› ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active-tab'));
            document.getElementById('tab-' + tabId).classList.add('active-tab');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.replace('text-zen-gold', 'text-gray-300');
            });
            event.currentTarget.classList.replace('text-gray-300', 'text-zen-gold');
            window.scrollTo(0,0);
        }

        // --- åŒ¯ç‡èˆ‡è¨ˆç®—æ©Ÿ ---
        function calculate() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('rate-input').value) || 0.21;
            try {
                // å®‰å…¨çš„ç°¡å–®è¨ˆç®—
                const sanitized = input.replace(/[^-+*/.0-9]/g, '');
                const result = eval(sanitized) || 0;
                document.getElementById('calc-result').innerText = (result * rate).toLocaleString(undefined, {maximumFractionDigits: 0});
            } catch (e) { /* éœé»˜è™•ç†è¨ˆç®—éŒ¯èª¤ */ }
        }

        // --- è¨˜å¸³åŠŸèƒ½ (æ”¹ç”¨ FIREBASE FIRESTORE åŒæ­¥) ---
        let currentPhoto = "";
        function handleImage(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 300; // å£“ç¸®ç¸®åœ–
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentPhoto = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-preview').src = currentPhoto;
                    document.getElementById('preview-container').classList.remove('hidden');
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        // *** æ–°å¢/ç·¨è¼¯è²»ç”¨ (ä½¿ç”¨ Firestore) ***
        function addExpense() {
            const name = document.getElementById('item-name').value;
            const amount = document.getElementById('item-amount').value;
            
            if(!name || !amount) return;
            
            // è¨ˆç®— TWD (åŒ¯ç‡ä»ä½¿ç”¨æœ¬åœ°è¨­å®š)
            const rate = parseFloat(document.getElementById('rate-input').value) || 0.21;

            const expense = {
                name,
                amount: parseFloat(amount),
                photo: currentPhoto, // Base64 ç·¨ç¢¼çš„åœ–ç‰‡
                twd: Math.round(amount * rate),
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // è¨˜éŒ„ä¼ºæœå™¨æ™‚é–“æˆ³è¨˜ï¼Œç”¨æ–¼æ’åº
            };
            
            // å°‡è³‡æ–™æ–°å¢åˆ° Firestore é›†åˆ
            db.collection(EXPENSES_COLLECTION).add(expense)
                .then(() => {
                    // é‡ç½®è¡¨å–® (æˆåŠŸå¯«å…¥å¾Œï¼Œæ¸²æŸ“å‡½æ•¸æœƒè‡ªå‹•æ›´æ–°åˆ—è¡¨)
                    document.getElementById('item-name').value = "";
                    document.getElementById('item-amount').value = "";
                    currentPhoto = "";
                    document.getElementById('preview-container').classList.add('hidden');
                })
                .catch((error) => {
                    console.error("Error writing document: ", error);
                    alert("è³‡æ–™å¯«å…¥é›²ç«¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                });
        }

        // *** æ¸²æŸ“è²»ç”¨èˆ‡å³æ™‚ç›£è½ (ä½¿ç”¨ Firestore) ***
        function renderExpenses() {
            const container = document.getElementById('expense-list');
            
            // ç›£è½ Firestore é›†åˆçš„è®Šå‹•ï¼Œä¸¦æŒ‰æ™‚é–“æˆ³è¨˜é™åºæ’åˆ—
            db.collection(EXPENSES_COLLECTION)
              .orderBy("timestamp", "desc") // è®“æœ€æ–°çš„åœ¨æœ€ä¸Šé¢
              .onSnapshot((snapshot) => {
                let expenses = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.amount !== undefined) {
                         expenses.push({
                            id: doc.id, // Firestore æ–‡ä»¶ ID
                            ...data
                        });
                    }
                });
                
                // ä½¿ç”¨å–å¾—çš„æ•¸æ“šä¾†æ¸²æŸ“ HTML
                container.innerHTML = expenses.map(ex => `
                    <div class="zen-card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            ${ex.photo ? `<img src="${ex.photo}" class="w-10 h-10 rounded object-cover shadow-sm">` : `<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-xs">ç„¡åœ–</div>`}
                            <div>
                                <p class="text-sm font-bold">${ex.name}</p>
                                <p class="text-[10px] text-gray-400">Â¥${ex.amount ? ex.amount.toLocaleString() : '0'} â†’ NT$${ex.twd ? ex.twd.toLocaleString() : '0'}</p>
                            </div>
                        </div>
                        <button onclick="deleteExpense('${ex.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fas fa-trash-alt text-xs"></i></button>
                    </div>
                `).join('');
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
                container.innerHTML = `<p class="text-red-500 text-center">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šå’Œ Firebase è¨­å®šã€‚</p>`;
            });
        }

        // *** åˆªé™¤è²»ç”¨ (ä½¿ç”¨ Firestore) ***
        function deleteExpense(docId) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é–‹éŠ·å—ï¼Ÿ")) return;
            
            db.collection(EXPENSES_COLLECTION).doc(docId).delete()
                .then(() => {
                    console.log("Document successfully deleted!");
                    // åˆ—è¡¨æœƒè‡ªå‹•æ›´æ–°
                })
                .catch((error) => {
                    console.error("Error removing document: ", error);
                    alert("åˆªé™¤å¤±æ•—ã€‚");
                });
        }

        // --- æ¸…å–®èˆ‡å‚™å¿˜éŒ„ (ä¿ç•™ LocalStorage) ---
        const initialChecklist = [
            "è­·ç…§ (æ­£æœ¬+å½±æœ¬)", "æ—¥å¹£ç¾é‡‘ / ä¿¡ç”¨å¡", "æ©Ÿç¥¨è¡Œç¨‹è¡¨", "æ—¥æœ¬ä¸Šç¶²å¡ (Esim)", "è¡Œå‹•é›»æº (éš¨èº«)", "ç›¸æ©Ÿ / å……é›»å™¨", "æ­¢ç€‰è—¥ / æ„Ÿå†’è—¥", "æ‘ºç–Šé›¨å‚˜", "ç‰™åˆ·ç‰™è†", "æš–æš–åŒ… / æ‰‹å¥— / åœå·¾"
        ];

        function initChecklist() {
            const saved = JSON.parse(localStorage.getItem('trip_checklist') || "{}");
            const container = document.getElementById('checklist-container');
            container.innerHTML = initialChecklist.map((item, idx) => `
                <label class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-100 text-sm">
                    <input type="checkbox" onchange="saveCheck(${idx})" ${saved[idx] ? 'checked' : ''} class="w-5 h-5 accent-pink-400">
                    <span class="${saved[idx] ? 'line-through text-gray-400' : ''}">${item}</span>
                </label>
            `).join('');
        }

        function saveCheck(idx) {
            const saved = JSON.parse(localStorage.getItem('trip_checklist') || "{}");
            saved[idx] = !saved[idx];
            localStorage.setItem('trip_checklist', JSON.stringify(saved));
            initChecklist();
        }

        // --- å‚™å¿˜éŒ„ç¶²å€è½‰æ› ---
        const memoInput = document.getElementById('memo-input');
        memoInput.addEventListener('input', () => {
            const text = memoInput.value;
            localStorage.setItem('trip_memo', text);
            updateMemoLinks(text);
        });

        function updateMemoLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex) || [];
            const linkContainer = document.getElementById('memo-links');
            linkContainer.innerHTML = urls.map(url => `
                <a href="${url}" target="_blank" class="bg-blue-50 text-blue-600 text-[10px] px-2 py-1 rounded-full border border-blue-100">
                    <i class="fas fa-link"></i> ${new URL(url).hostname}
                </a>
            `).join('');
        }

        // --- è¡Œç¨‹å‚™è¨»ç·¨è¼¯ ---
        function editNote(id) {
            const current = localStorage.getItem('trip_' + id) || "é»æ“Šè¨­å®šå‚™è¨»...";
            const val = prompt("è¼¸å…¥ä»Šæ—¥é‡è¦å‚™è¨» (å¦‚é›†åˆæ™‚é–“æˆ–é¤å»³):", current);
            if(val) {
                document.getElementById(id).innerHTML = `<i class="fas fa-edit mr-1"></i> ${val}`;
                localStorage.setItem('trip_' + id, val);
            }
        }

        // --- åˆå§‹åŒ–é é¢ ---
        window.onload = () => {
            renderExpenses(); // å¾ Firebase è¼‰å…¥
            initChecklist(); // å¾ LocalStorage è¼‰å…¥
            const savedMemo = localStorage.getItem('trip_memo') || "";
            memoInput.value = savedMemo;
            updateMemoLinks(savedMemo);
            
            // è¼‰å…¥è¡Œç¨‹å‚™è¨»
            ['note-d1'].forEach(id => {
                const saved = localStorage.getItem('trip_' + id);
                if(saved) document.getElementById(id).innerHTML = `<i class="fas fa-edit mr-1"></i> ${saved}`;
            });
        };
    </script>
</body>
</html>